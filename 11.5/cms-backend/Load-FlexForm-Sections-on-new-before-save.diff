From 8a3564ec258ad27b5bd89f3d80281a735bf6bc45 Mon Sep 17 00:00:00 2001
From: AOE Dev <dev@aoe.com>
Date: Tue, 12 Oct 2021 12:15:40 +0200
Subject: [PATCH] [BUGFIX] Load FlexForm Sections on new before save

FlexForm Section can be added before content element is saved.
This is done by ensuring that processedTca have a value for list_type.

Earlier the pi_flexform was ignored as the default values on create
before save was empty.

Resolves: #81684
Releases: master, 11.5, 10.4, 9.5
Change-Id: I62e03cbbd93e8785f58c24dad1e573e8b5e0202b
---
 typo3/sysext/backend/Classes/Controller/FormFlexAjaxController.php | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/typo3/sysext/backend/Classes/Controller/FormFlexAjaxController.php b/typo3/sysext/backend/Classes/Controller/FormFlexAjaxController.php
index a40747ea..e6e7c8fe 100644
--- a/typo3/sysext/backend/Classes/Controller/FormFlexAjaxController.php
+++ b/typo3/sysext/backend/Classes/Controller/FormFlexAjaxController.php
@@ -86,6 +86,9 @@ class FormFlexAjaxController extends AbstractFormEngineAjaxController
         // @see issue #80100 for a series of changes in this area
         if ($command === 'new') {
             $formDataCompilerInput['databaseRow']['uid'] = $databaseRowUid;
+            $dataStructureKey = $queryParameters['dataStructureIdentifier']['dataStructureKey'];
+            $subtypeValue = substr($dataStructureKey, 0, strpos($dataStructureKey, ','));
+            $formDataCompilerInput['databaseRow'][$processedTca['types'][$recordTypeValue]['subtype_value_field']] = $subtypeValue;
         }
         $formData = $formDataCompiler->compile($formDataCompilerInput);
 
-- 
2.33.0

